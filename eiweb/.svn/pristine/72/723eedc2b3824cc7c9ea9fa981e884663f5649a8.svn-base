<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="skt.eiweb.file.mapper.FileMapper">

    <insert id="insertFile" parameterType="skt.eiweb.file.model.File">
    <![CDATA[
        INSERT INTO model_file 
               (reg_date, user_id, model_id, file_code, file_name, file_size, file_ext, model_version)
        VALUES (current_timestamp, #{userId}, #{modelId}, #{fileCode}, #{fileName}, #{fileSize}, #{fileExt}, #{modelVersion})
    ]]>
    </insert>

    <select id="selectFile" parameterType="skt.eiweb.file.model.FileDto" resultType="skt.eiweb.file.model.FileDto">
        SELECT f.*
          FROM model_file f LEFT OUTER JOIN model m ON f.model_id = m.model_id
         WHERE 1 = 1
         <if test="userId != null">AND f.user_id = #{userId}</if>
         <if test="modelId != null">AND f.model_id = #{modelId}</if>
         <if test="fileCode != null">AND file_code = #{fileCode}</if>
         <if test="fileName != null">AND file_name = #{fileName}</if>
         <if test="fileSize != null">AND file_size = #{fileSize}</if>
         <if test="fileExt != null">AND file_ext = #{fileExt}</if>
         <if test="modelVersion != null">AND model_version = #{modelVersion}</if>
         <if test="version != null">AND file_code LIKE CONCAT('%.', #{version}, '.%')</if>
         <if test="fileCodes != null">AND file_code IN (''<foreach collection="fileCodes" item="fileCode">, #{fileCode}</foreach>)</if>
    </select>

    <update id="updateFile" parameterType="skt.eiweb.file.model.FileDto">
        UPDATE model_file 
           SET file_code = #{newFileCode}, model_id = #{modelId}, model_version = #{modelVersion}
         WHERE file_code = #{fileCode}
    </update>
    
    <delete id="deleteFile" parameterType="skt.eiweb.file.model.FileDto">
        DELETE FROM model_file 
         WHERE file_code = #{fileCode}
    </delete>

    <select id="selectNewFileCodes" parameterType="skt.eiweb.file.model.FileDto" resultType="skt.eiweb.file.model.FileDto">
        SELECT * FROM model_file 
         WHERE model_id is NULL AND file_code IN (''<foreach collection="fileCodes" item="fileCode">, #{fileCode}</foreach>)
    </select>

    <select id="selectDelFileCodes" parameterType="skt.eiweb.file.model.FileDto" resultType="skt.eiweb.file.model.FileDto">
        SELECT * FROM model_file 
         WHERE model_id = #{modelId} AND file_code NOT IN (''<foreach collection="fileCodes" item="fileCode">, #{fileCode}</foreach>)
    </select>

    <select id="notMappingFiles" resultType="skt.eiweb.file.model.FileDto">
        SELECT * FROM model_file 
         WHERE model_id IS NULL
    </select>

</mapper>