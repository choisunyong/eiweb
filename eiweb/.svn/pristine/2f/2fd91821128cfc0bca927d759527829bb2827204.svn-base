<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="skt.eiweb.admin.mapper.AdminMapper">

    <select id="selectUserLoginHistory" parameterType="skt.eiweb.admin.model.LoginHistoryDto" resultType="skt.eiweb.admin.model.LoginHistoryDto">
      SELECT * FROM (
        SELECT @RNUM := @RNUM + 1 AS NO, TAB.* FROM (
          SELECT DATE_FORMAT(LOGIN_DATE,"%Y-%m-%d %H:%i:%S") LOGIN_DATE, 
                 LOGIN_DATE ORD, 
			           HIST.USER_ID,
			           FN_GET_USER_NAME(HIST.USER_ID) USER_NAME,
			           SESSION,
			           FN_GET_CODE_NAME('PERMISSION',USR.USER_PERMISSION) USER_GROUP
        FROM LOGIN_HISTORY HIST LEFT OUTER JOIN USER USR ON USR.USER_ID = HIST.USER_ID 
       WHERE 1=1
		    <if test="schKey != null">
			    AND ( HIST.USER_ID LIKE CONCAT('%',#{schKey},'%' ) OR USER_NAME LIKE CONCAT('%',#{schKey},'%' ) )
		    </if>
		    <if test="startDate != null and endDate != null">
			    AND LOGIN_DATE BETWEEN STR_TO_DATE(CONCAT(#{startDate},'000000'), '%Y%m%d%H%i%S') AND STR_TO_DATE(CONCAT(#{endDate},'235959'), '%Y%m%d%H%i%S')
		    </if>
		    <if test="userPermission != null">
			    AND (FN_GET_CODE_NAME('PERMISSION',USR.USER_PERMISSION) LIKE CONCAT('%',#{userPermission},'%')
				  OR USR.USER_PERMISSION LIKE CONCAT('%',#{userPermission},'%'))
		    </if>
		    ) TAB, (SELECT @RNUM :=0) B
		    ORDER BY ORD DESC
		  ) OTAB
      WHERE NO BETWEEN (((#{page}-1)*#{pageCount})+1) AND (#{page}*#{pageCount})
    </select>
    
    <select id="selectUserLoginHistoryTotalCount" parameterType="skt.eiweb.admin.model.LoginHistoryDto" resultType="int">
      SELECT COUNT(*) TOTAL_COUNT 
        FROM LOGIN_HISTORY HIST LEFT OUTER JOIN USER USR ON USR.USER_ID = HIST.USER_ID 
       WHERE 1=1
		    <if test="schKey != null">
			    AND ( HIST.USER_ID LIKE CONCAT('%',#{schKey},'%' ) OR USER_NAME LIKE CONCAT('%',#{schKey},'%' ) )
		    </if>
		    <if test="startDate != null and endDate != null">
			    AND LOGIN_DATE BETWEEN STR_TO_DATE(CONCAT(#{startDate},'000000'), '%Y%m%d%H%i%S') AND STR_TO_DATE(CONCAT(#{endDate},'235959'), '%Y%m%d%H%i%S')
		    </if>
		    <if test="userPermission != null">
			    AND (FN_GET_CODE_NAME('PERMISSION',USR.USER_PERMISSION) LIKE CONCAT('%',#{userPermission},'%')
				  OR USR.USER_PERMISSION LIKE CONCAT('%',#{userPermission},'%'))
		    </if>
    </select>
    
    <select id="selectServiceCreHistory" parameterType="skt.eiweb.service.model.ServiceCreHistory" resultType="skt.eiweb.service.model.ServiceCreHistoryDto">
      SELECT * FROM ( 
        SELECT @RNUM := @RNUM + 1 AS NO, TAB.* FROM (
          SELECT DATE_FORMAT(CREATION_DATE,"%Y-%m-%d") CREATION_DATE, 
                 CREATION_DATE ORD, 
                 FN_GET_USER_NAME(SVC.USER_ID) USER_NAME, 
                 SERVICE_ID, 
                 SERVICE_NAME,
                 SVC.MODEL_ID,
                 MD.MODEL_NAME,
                 SVC.VERSION,
                 RUN_CYCLE,
                 RESOURCE_GROUP_ID
          FROM SERVICE_CRE_HISTORY SVC LEFT OUTER JOIN MODEL MD ON SVC.MODEL_ID = MD.MODEL_ID 
         WHERE 1=1
          <if test="serviceId != null">
			      AND SERVICE_ID = #{serviceId}
		      </if>
		      <if test="version != null">
			      AND SVC.VERSION = #{version}
		      </if>
		      <if test="schKey != null">
			      AND SERVICE_NAME LIKE CONCAT('%',#{schKey},'%' )
				    OR FN_GET_USER_NAME(SVC.USER_ID) LIKE CONCAT('%',#{schKey},'%' )
				    OR MD.MODEL_NAME LIKE CONCAT('%',#{schKey},'%' )
		      </if>
		    ) TAB, (SELECT @RNUM :=0) B
		    ORDER BY ORD DESC, CAST(VERSION AS ) DESC
		  ) OTAB
		  WHERE NO BETWEEN (((#{page}-1)*#{pageCount})+1) AND (#{page}*#{pageCount})
    </select>
    
    <select id="selectServiceCreHistoryTotalCount" parameterType="skt.eiweb.service.model.ServiceCreHistory" resultType="int">
      SELECT COUNT(*) TOTAL_COUNT 
        FROM SERVICE_CRE_HISTORY SVC LEFT OUTER JOIN MODEL MD ON SVC.MODEL_ID = MD.MODEL_ID 
       WHERE 1=1
		    <if test="schKey != null">
			    AND SERVICE_NAME LIKE CONCAT('%',#{schKey},'%' )
				  OR FN_GET_USER_NAME(SVC.USER_ID) LIKE CONCAT('%',#{schKey},'%' )
				  OR MD.MODEL_NAME LIKE CONCAT('%',#{schKey},'%' )
		    </if>
    </select>

    <select id="selectServiceExecHistory" parameterType="skt.eiweb.service.model.ServiceExecHistory" resultType="skt.eiweb.service.model.ServiceExecHistoryDto">
      SELECT * FROM ( 
        SELECT @RNUM := @RNUM + 1 AS NO, TAB.* FROM (
          SELECT  SVCH.SERVICE_NAME,
			            SVCH.SERVICE_ID,
			            SVCH.VERSION,
                  SVCH.SERVICE_GROUP_NAME,
                  SVC.DAG_ID,
                  DATE_FORMAT(SVCH.START_DATE,"%Y-%m-%d %H:%i:%S") START_DATE,
                  DATE_FORMAT(SVCH.END_DATE,"%Y-%m-%d %H:%i:%S") END_DATE,
                  (CASE WHEN SVCH.END_DATE IS NULL THEN (NOW() - SVCH.START_DATE) ELSE (SVCH.END_DATE - SVCH.START_DATE) END) ELAPSED,
                  SVCH.SERVICE_STATUS,
                  EXECUTE_DATE ORD
		        FROM   SERVICE_EXEC_HISTORY SVCH, SERVICE SVC, MODEL MD
		       WHERE SVCH.SERVICE_ID = SVC.SERVICE_ID AND SVCH.VERSION = SVC.VERSION
		          AND SVCH.MODEL_ID = MD.MODEL_ID AND SVC.MODEL_ID = MD.MODEL_ID
		        <if test="serviceId != null">
			        AND SVCH.SERVICE_ID = #{serviceId}
		        </if>
		        <if test="serviceGroupName != null">
			        AND SVCH.SERVICE_GROUP_NAME = #{serviceGroupName}
		        </if>
		        <if test="serviceStatus != null">
			        <if test="serviceStatus == 'success'">
				        AND SVCH.SERVICE_STATUS = 'success'
			        </if>
			        <if test="serviceStatus != 'success'">
				        AND SVCH.SERVICE_STATUS != 'success'
			        </if>
		        </if>
		        <if test="schKey != null">
			        AND SVCH.SERVICE_NAME LIKE CONCAT('%',#{schKey},'%' )
				      OR SVC.DAG_ID LIKE CONCAT('%',#{schKey},'%' )
		        </if>
		        <if test="startDate != null and endDate != null">
			        AND SVCH.START_DATE BETWEEN STR_TO_DATE(CONCAT(#{startDate},'000000'), '%Y%m%d%H%i%S') AND STR_TO_DATE(CONCAT(#{endDate},'235959'), '%Y%m%d%H%i%S')
		      </if>
		    ) TAB, (SELECT @RNUM :=0) B
		    ORDER BY ORD DESC
		  ) OTAB
		  WHERE NO BETWEEN (((#{page}-1)*#{pageCount})+1) AND (#{page}*#{pageCount})
    </select>

    <select id="selectServiceExecHistoryTotalCount" parameterType="skt.eiweb.service.model.ServiceExecHistory" resultType="int">
      SELECT COUNT(*) TOTAL_COUNT
		    FROM SERVICE_EXEC_HISTORY SVCH, SERVICE SVC, MODEL MD
		   WHERE SVCH.SERVICE_ID = SVC.SERVICE_ID AND SVCH.VERSION = SVC.VERSION
		      AND SVCH.MODEL_ID = MD.MODEL_ID AND SVC.MODEL_ID = MD.MODEL_ID
		      <if test="serviceId != null">
			      AND SVCH.SERVICE_ID = #{serviceId}
		      </if>
		      <if test="serviceGroupName != null">
			      AND SVCH.SERVICE_GROUP_NAME = #{serviceGroupName}
		      </if>
		      <if test="serviceStatus != null">
			      <if test="serviceStatus == 'success'">
				      AND SVCH.SERVICE_STATUS = 'success'
			      </if>
			      <if test="serviceStatus != 'success'">
				      AND SVCH.SERVICE_STATUS != 'success'
			      </if>
		      </if>
		      <if test="schKey != null">
			      AND SVCH.SERVICE_NAME LIKE CONCAT('%',#{schKey},'%' )
				    OR SVC.DAG_ID LIKE CONCAT('%',#{schKey},'%' )
		      </if>
		      <if test="startDate != null and endDate != null">
			      AND SVCH.START_DATE BETWEEN STR_TO_DATE(CONCAT(#{startDate},'000000'), '%Y%m%d%H%i%S') AND STR_TO_DATE(CONCAT(#{endDate},'235959'), '%Y%m%d%H%i%S')
		      </if>
    </select>

    <select id="selectRestExecHistory" parameterType="skt.eiweb.admin.model.RestExecHistory" resultType="skt.eiweb.admin.model.RestExecHistoryDto">
      SELECT * FROM ( 
        SELECT @RNUM := @RNUM + 1 AS NO, TAB.* FROM (
          SELECT DATE_FORMAT(EXECUTE_DATE,"%Y-%m-%d") EXECUTE_DATE,
                 EXECUTE_DATE ORD, 
                 FN_GET_USER_NAME(REH.USER_ID) USERNAME,
                 REH.USER_ID, 
                 SERVICE_ID, 
                 SERVICE_NAME, 
                 REH.MODEL_ID, 
                 MD.MODEL_NAME, 
                 REH.VERSION, 
                 RUN_CYCLE, 
                 RESOURCE_GROUP_ID, 
                 SUCCESS, 
                 DATE_FORMAT(ELAPSED_TIME,"%Y-%m-%d") ELAPSED_TIME
            FROM REST_EXEC_HISTORY REH LEFT OUTER JOIN MODEL MD ON REH.MODEL_ID = MD.MODEL_ID 
           WHERE 1=1
		        <if test="schKey != null">
			        AND REH.SERVICE_NAME LIKE CONCAT('%',#{schKey},'%' )
				      OR FN_GET_USER_NAME(REH.USER_ID) LIKE CONCAT('%',#{schKey},'%' )
				      OR MD.MODEL_NAME LIKE CONCAT('%',#{schKey},'%' )
		        </if>
		    ) TAB, (SELECT @RNUM :=0) B
		    ORDER BY ORD DESC
		  ) OTAB
		  WHERE NO BETWEEN (((#{page}-1)*#{pageCount})+1) AND (#{page}*#{pageCount})
    </select>

    <select id="selectRestExecHistoryTotalCount" parameterType="skt.eiweb.admin.model.RestExecHistory" resultType="int">
      SELECT COUNT(*) TOTAL_COUNT
        FROM REST_EXEC_HISTORY REH LEFT OUTER JOIN MODEL MD ON REH.MODEL_ID = MD.MODEL_ID 
       WHERE 1=1
        <if test="schKey != null">
          AND REH.SERVICE_NAME LIKE CONCAT('%',#{schKey},'%' )
          OR FN_GET_USER_NAME(REH.USER_ID) LIKE CONCAT('%',#{schKey},'%' )
          OR MD.MODEL_NAME LIKE CONCAT('%',#{schKey},'%' )
        </if>
    </select>

    <select id="selectResourceGroupList" parameterType="skt.eiweb.admin.model.ResourceGroup" resultType="skt.eiweb.admin.model.ResourceGroupDto">
      SELECT * FROM ( 
        SELECT @RNUM := @RNUM + 1 AS NO, TAB.* FROM (
          SELECT DATE_FORMAT(CREATE_DATE,"%Y-%m-%d") CREATE_DATE, 
                 CREATE_DATE ORD, 
                 RESOURCE_GROUP_ID, 
                 RESOURCE_GROUP_NAME, 
                 RESOURCE_CPU, USER_ID,
                 FN_GET_USER_NAME(USER_ID) USERNAME 
            FROM RESOURCE_GROUP 
           WHERE 1=1
		        <if test="schKey != null">
			        AND RESOURCE_GROUP_NAME LIKE CONCAT('%',#{schKey},'%' )
				      OR FN_GET_USER_NAME(USER_ID) LIKE CONCAT('%',#{schKey},'%' )
		        </if>
		        <if test="resourceGroupId != null">
			        AND RESOURCE_GROUP_ID=#{resourceGroupId}
		        </if>
		    ) TAB, (SELECT @RNUM :=0) B
		    ORDER BY ORD DESC
      ) OTAB
      WHERE NO BETWEEN (((#{page}-1)*#{pageCount})+1) AND (#{page}*#{pageCount})
    </select>

    <select id="selectResourceGroupAllList" parameterType="skt.eiweb.admin.model.ResourceGroup" resultType="skt.eiweb.admin.model.ResourceGroupDto">
      SELECT DATE_FORMAT(CREATE_DATE,"%Y-%m-%d") CREATE_DATE, 
             RESOURCE_GROUP_ID, 
             RESOURCE_GROUP_NAME, 
             RESOURCE_CPU, 
             USER_ID,
			       FN_GET_USER_NAME(USER_ID) USERNAME 
        FROM RESOURCE_GROUP 
       WHERE 1=1
		    <if test="schKey != null">
			    AND RESOURCE_GROUP_NAME LIKE CONCAT('%',#{schKey},'%' )
				  OR FN_GET_USER_NAME(USER_ID) LIKE CONCAT('%',#{schKey},'%' )
		    </if>
    </select>

    <select id="selectResourceGroupListTotalCount" parameterType="skt.eiweb.admin.model.ResourceGroup" resultType="int">
      SELECT COUNT(*) TOTAL_COUNT 
        FROM RESOURCE_GROUP 
       WHERE 1=1
		    <if test="schKey != null">
			    AND RESOURCE_GROUP_NAME LIKE CONCAT('%',#{schKey},'%' )
				  OR FN_GET_USER_NAME(USER_ID) LIKE CONCAT('%',#{schKey},'%' )
		    </if>
    </select>

    <insert id="insertResourceGroup" parameterType="skt.eiweb.admin.model.ResourceGroup">
      INSERT INTO RESOURCE_GROUP 
             (RESOURCE_GROUP_NAME, RESOURCE_CPU, CREATE_DATE, USER_ID)
      VALUES (#{resourceGroupName}, #{resourceCpu}, current_timestamp, #{userId})
    </insert>

    <update id="updateResourceGroup" parameterType="skt.eiweb.admin.model.ResourceGroup">
      UPDATE RESOURCE_GROUP 
         SET RESOURCE_GROUP_NAME = #{resourceGroupName}, RESOURCE_CPU=#{resourceCpu}
       WHERE RESOURCE_GROUP_ID=#{resourceGroupId}
    </update>

    <delete id="deleteResourceGroup" parameterType="skt.eiweb.admin.model.ResourceGroup">
      DELETE FROM RESOURCE_GROUP WHERE RESOURCE_GROUP_ID=#{resourceGroupId}
    </delete>

    <select id="selectScaleHistory" parameterType="skt.eiweb.admin.model.ScaleHistory" resultType="skt.eiweb.admin.model.ScaleHistoryDto">
      SELECT * FROM ( 
        SELECT @RNUM := @RNUM + 1 AS NO, TAB.* FROM (
          SELECT DATE_FORMAT(EXECUTE_DATE,'%Y-%m-%d %H:%i:%s') EXECUTE_DATE, 
                 EXECUTE_DATE ORD,
                 SERVER_NAME,
                 ACTION,
                 USER_ID
            FROM REST_EXEC_HISTORY 
           WHERE 1=1
		        <if test="serverName != null"> AND UPPER(SERVER_NAME) = UPPER(#{serverName})</if>
		        <if test="scaleInOutType != null"> AND UPPER(ACTION) = UPPER(#{scaleInOutType})</if>
		        <if test="startDate != null and endDate != null">
			        AND EXECUTE_DATE BETWEEN STR_TO_DATE(CONCAT(#{startDate},'000000'), '%Y%m%d%H%i%S') AND STR_TO_DATE(CONCAT(#{endDate},'235959'), '%Y%m%d%H%i%S')
		        </if>
	    	) TAB, (SELECT @RNUM :=0) B
		    ORDER BY ORD DESC
		  ) OTAB
		  WHERE NO BETWEEN (((#{page}-1)*#{pageCount})+1) AND (#{page}*#{pageCount})
    </select>

    <select id="selectScaleHistoryTotalCount" parameterType="skt.eiweb.admin.model.ScaleHistory" resultType="int">
      SELECT COUNT(*) TOTAL_COUNT 
        FROM REST_EXEC_HISTORY 
       WHERE 1=1
		    <if test="serverName != null"> AND UPPER(SERVER_NAME) = UPPER(#{serverName})</if>
		    <if test="scaleInOutType != null"> AND UPPER(ACTION) = UPPER(#{scaleInOutType})</if>
		    <if test="startDate != null and endDate != null">
			    AND EXECUTE_DATE BETWEEN STR_TO_DATE(CONCAT(#{startDate},'000000'), '%Y%m%d%H%i%S') AND STR_TO_DATE(CONCAT(#{endDate},'235959'), '%Y%m%d%H%i%S')
        </if>
    </select>

    <insert id="insertScaleHistory" parameterType="skt.eiweb.admin.model.ScaleHistory">
      INSERT INTO SCALE_HISTORY 
             ( RUN_DATE, USER_ID, SERVER_NAME, ACTION )
      VALUES ( CURRENT_TIMESTAMP, #{userId}, #{serverName}, #{action} )
    </insert>

    <select id="deviceList" parameterType="skt.eiweb.admin.model.Device" resultType="skt.eiweb.admin.model.Device">
      SELECT CODE_NAME SERVER_NAME, CODE INSTANCE, VALUE ROLE
		    FROM COMMON_CODE CD INNER JOIN COMMON_GROUP GRP ON GRP.GROUP_CODE = CD.GROUP_CODE
		   WHERE GRP.GROUP_CODE='SCALE_IN_OUT_LIST'
         AND GRP.USE_YN='Y' 
         AND CD.USE_YN='Y'
		    <if test="schKey != null">
			    AND CODE_NAME LIKE CONCAT('%',#{schKey},'%' )
				  OR CODE LIKE CONCAT('%',#{schKey},'%' )
		    </if>
       ORDER BY CD.SORT
    </select>

    <!-- 서비스 그룹 관리 _ begin -->
    <select id="selectServiceGroupList" parameterType="skt.eiweb.admin.model.ServiceGroup" resultType="skt.eiweb.admin.model.ServiceGroupDto">
      SELECT * FROM ( 
        SELECT @RNUM := @RNUM + 1 AS NO, TAB.* FROM (
          SELECT DATE_FORMAT(CREATION_DATE,"%Y-%m-%d") CREATION_DATE, 
                 CREATION_DATE ORD,
                 SERVICE_GROUP_NAME, 
                 DESCRIPTION
            FROM SERVICE_GROUP 
           WHERE 1=1
		        <if test="schKey != null">
			        AND SERVICE_GROUP_NAME LIKE CONCAT('%',#{schKey},'%' )
		        </if>
		        <if test="serviceGroupName != null">
			        AND SERVICE_GROUP_NAME=#{serviceGroupName}
		        </if>
		    ) TAB, (SELECT @RNUM :=0) B
		    ORDER BY ORD DESC
		  ) OTAB
      WHERE NO BETWEEN (((#{page}-1)*#{pageCount})+1) AND (#{page}*#{pageCount})
    </select>

    <select id="selectServiceGroupAllList" parameterType="skt.eiweb.admin.model.ServiceGroup" resultType="skt.eiweb.admin.model.ServiceGroupDto">
      SELECT DATE_FORMAT(creation_date,"%Y-%m-%d") CREATION_DATE, 
             SERVICE_GROUP_NAME, 
             DESCRIPTION
        FROM SERVICE_GROUP 
       WHERE 1=1
		    <if test="schKey != null">
			    AND SERVICE_GROUP_NAME LIKE CONCAT('%',#{schKey},'%' )
        </if>
    </select>

    <select id="selectServiceGroupListTotalCount" parameterType="skt.eiweb.admin.model.ServiceGroup" resultType="int">
      SELECT COUNT(*) TOTAL_COUNT 
        FROM SERVICE_GROUP 
       WHERE 1=1
		    <if test="schKey != null">
			    AND SERVICE_GROUP_NAME LIKE CONCAT('%',#{schKey},'%' )
		    </if>
    </select>

    <insert id="insertServiceGroup" parameterType="skt.eiweb.admin.model.ServiceGroup">
      INSERT INTO SERVICE_GROUP 
             (CREATION_DATE, SERVICE_GROUP_NAME<if test="description != null">, DESCRIPTION</if>) 
		  VALUES ( CURRENT_TIMESTAMP, #{serviceGroupName}<if test="description != null">, #{description}</if>)
    </insert>

    <!-- <update id="udpateServiceGroup" parameterType="skt.eiweb.admin.model.ServiceGroup">
        UPDATE service_group
           SET service_group_name = #{serviceGroupName} 
         WHERE service_group_name = #{serviceGroupName}
    </update> -->

    <select id="countServiceGroupByServiceGroupName" parameterType="skt.eiweb.admin.model.ServiceGroup" resultType="int">
      SELECT COUNT(*) 
        FROM SERVICE_GROUP 
       WHERE SERVICE_GROUP_NAME=#{serviceGroupName}
    </select>

    <delete id="deleteServiceGroup" parameterType="skt.eiweb.admin.model.ServiceGroup">
      DELETE FROM SERVICE_GROUP 
       WHERE SERVICE_GROUP_NAME=#{serviceGroupName}
    </delete>

    <select id="useServiceGroup" parameterType="skt.eiweb.admin.model.ServiceGroup" resultType="int" >
      SELECT COUNT(*) 
        FROM SERVICE
       WHERE SERVICE_GROUP_NAME=#{serviceGroupName}
    </select>
    <!-- 서비스 그룹 관리 _ end -->

</mapper>
