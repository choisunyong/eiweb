<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="skt.eiweb.model.mapper.ModelMapper">

    <select id="selectModel" parameterType="skt.eiweb.model.model.Model" resultType="skt.eiweb.model.model.ModelDto">
      SELECT * FROM (
			SELECT @RNUM := @RNUM + 1 AS NO, TAB.* FROM (
            SELECT DATE_FORMAT(REG_DATE,"%Y-%m-%d") REG_DATE, 
                   REG_DATE ORD,
                   FN_GET_CODE_VALUE_NAME('MODEL_PRIORITY',PRIORITY) PRIORITYNM,
                   FN_GET_USER_NAME(USER_ID) USERNAME,
                   LIMIT_RUNTIME,
                   EVALUATION_STATUS,
                   CONCAT(CPU_CORES,' / ',ELAPSED,' sec.') TEST_RESULT,
                   ELAPSED,
                   USER_ID, 
                   MODEL_NAME,
                   MODEL_ID,
                   VERSION, 
                   PRIORITY, 
                   CPU_CORES,
                   BASE_IMAGE,
                   MODEL_DESC
              FROM MODEL 
             WHERE 1=1
               <if test="modelId != null">
                  AND MODEL_ID = #{modelId}
               </if>
               <if test="schKey != null">
                  <if test="schType == 'modelName'">
                     AND MODEL_NAME LIKE CONCAT('%',#{schKey},'%' )
                  </if>
                  <if test="schType == 'user'">
                     AND USER_ID LIKE CONCAT('%',#{schKey},'%' ) OR FN_GET_USER_NAME(USER_ID) LIKE CONCAT('%',#{schKey},'%' )
                  </if>
               </if>
			) TAB, (SELECT @RNUM :=0) B
			ORDER BY ORD DESC
		) OTAB
		WHERE NO BETWEEN (((#{page}-1)*#{pageCount})+1) AND (#{page}*#{pageCount})
    </select>

    <select id="selectModelTotalCount" parameterType="skt.eiweb.model.model.Model" resultType="int">
      SELECT COUNT(*) TOTAL_COUNT FROM MODEL WHERE 1=1
		<if test="schKey != null">
			<if test="schType == 'modelName'">
				AND MODEL_NAME LIKE CONCAT('%',#{schKey},'%' )
			</if>
			<if test="schType == 'user'">
				AND USER_ID LIKE CONCAT('%',#{schKey},'%' ) OR FN_GET_USER_NAME(USER_ID) LIKE CONCAT('%',#{schKey},'%' )
			</if>
		</if>
    </select>

    <select id="makeNextModelId" resultType="string">
        SELECT FN_NEXT_MODEL_ID()
    </select>

    <insert id="insertModel" parameterType="skt.eiweb.model.model.Model">
      INSERT INTO MODEL 
             (REG_DATE, USER_ID, MODEL_NAME, MODEL_ID,VERSION,PRIORITY, BASE_IMAGE, MODEL_DESC,LIMIT_RUNTIME,EVALUATION_STATUS) 
      VALUES (CURRENT_TIMESTAMP, 
             #{userId}, 
             #{modelName}, 
             <if test="modelId == null">
               FN_NEXT_MODEL_ID(),
               1,
             </if>
             <if test="modelId != null">
               #{modelId},
               (SELECT MAX(VER)+1 VERSION FROM (SELECT MAX(VERSION) VER FROM MODEL WHERE MODEL_ID=#{modelId} UNION SELECT 0) A), 
             </if>
             #{priority},
             #{baseImage},
             #{modelDesc},
             #{limitRuntime},
             'init'
             )
    </insert>

    <select id="countModelByModelName" parameterType="skt.eiweb.model.model.Model" resultType="int">
      SELECT COUNT(*) FROM MODEL 
       WHERE MODEL_NAME=#{modelName} 
         <if test="modelId != null">
            AND MODEL_ID NOT IN (#{modelId})
         </if>
    </select>
    
    <delete id="deleteModel" parameterType="skt.eiweb.model.model.Model">
      DELETE FROM MODEL WHERE MODEL_ID=#{modelId}
    </delete>
    
    <insert id="insertModelHistory" parameterType="skt.eiweb.model.model.Model">
      INSERT INTO MODEL_REG_HISTORY 
             (REG_DATE, USER_ID, MODEL_NAME, MODEL_ID, VERSION, PRIORITY, BASE_IMAGE, MODEL_DESC,LIMIT_RUNTIME,EVALUATION_STATUS)
		SELECT REG_DATE, USER_ID, MODEL_NAME, MODEL_ID, VERSION,PRIORITY, BASE_IMAGE, MODEL_DESC,LIMIT_RUNTIME,EVALUATION_STATUS
        FROM MODEL 
       WHERE MODEL_ID=#{modelId}
    </insert>
    
    <update id="updateModel" parameterType="skt.eiweb.model.model.Model">
      UPDATE MODEL SET REG_DATE=CURRENT_TIMESTAMP,
         <if test="modelName != null">
            MODEL_NAME=#{modelName},
         </if>
         <if test="priority != null">
            PRIORITY=#{priority},
         </if>
         <if test="baseImage != null">
            BASE_IMAGE=#{baseImage},
         </if>
         <if test="limitRuntime != null">
            LIMIT_RUNTIME=#{limitRuntime},
         </if>
         <if test="evaluationStatus != null">
            EVALUATION_STATUS=#{evaluationStatus},
         </if>
         <if test="modelDesc != null">
            MODEL_DESC=#{modelDesc},
         </if>
         VERSION=VERSION+1
      WHERE MODEL_ID=#{modelId}
    </update>
    
    <select id="selectModelRegHist" parameterType="skt.eiweb.model.model.Model" resultType="skt.eiweb.model.model.ModelDto">
      SELECT * FROM (
			SELECT @RNUM := @RNUM + 1 AS NO, TAB.* FROM (
            SELECT DATE_FORMAT(REG_DATE,'%Y-%m-%d %H:%i:%s') REG_DATE, 
                   REG_DATE ORD,
                   FN_GET_USER_NAME(USER_ID) USERNAME,
                   LIMIT_RUNTIME,
                   EVALUATION_STATUS,
                   CONCAT(CPU_CORES,' / ',ELAPSED,'sec.') TEST_RESULT,
                   ELAPSED,
                   USER_ID, 
                   MODEL_NAME, 
                   MODEL_ID, 
                   VERSION, 
                   (CASE WHEN VERSION > 1 THEN 'Modify' ELSE 'Create' END) ACTION,
                   FN_GET_CODE_VALUE_NAME('MODEL_PRIORITY',PRIORITY) PRIORITYNM, 
                   CPU_CORES,BASE_IMAGE,
                   MODEL_DESC
              FROM MODEL_REG_HISTORY 
             WHERE 1=1
               <if test="modelId != null">
                  AND MODEL_ID = #{modelId}
               </if>
               <if test="version != null">
                  AND VERSION = #{version}
               </if>
               <if test="schKey != null">
                  AND (MODEL_NAME LIKE CONCAT('%',#{schKey},'%' ) OR MODEL_ID LIKE CONCAT('%',#{schKey},'%' ))
               </if>
               <if test="action != null">
                  <if test="action == 'CREATE'">
                     AND VERSION = 1
                  </if>
                  <if test="action == 'MODIFY'">
                     AND VERSION > 1
                  </if>
               </if>
               <if test="startDate != null and endDate != null">
                  AND REG_DATE BETWEEN STR_TO_DATE(CONCAT(#{startDate},'000000'), '%Y%m%d%H%i%S') AND STR_TO_DATE(CONCAT(#{endDate},'235959'), '%Y%m%d%H%i%S')
               </if>
         ) TAB, (SELECT @RNUM :=0) B
         ORDER BY ORD DESC, CAST(VERSION AS SIGNED) DESC
      ) OTAB
      WHERE NO BETWEEN (((#{page}-1)*#{pageCount})+1) AND (#{page}*#{pageCount})
    </select>
    
    <select id="selectModelRegHistTotalCount" parameterType="skt.eiweb.model.model.Model" resultType="int">
       SELECT COUNT(*) TOTAL_COUNT 
         FROM MODEL_REG_HISTORY 
        WHERE 1=1
         <if test="modelId != null">
            AND MODEL_ID = #{modelId}
         </if>
         <if test="version != null">
            AND VERSION = #{version}
         </if>
         <if test="schKey != null">
            AND (MODEL_NAME LIKE CONCAT('%',#{schKey},'%' ) OR MODEL_ID LIKE CONCAT('%',#{schKey},'%' ))
         </if>
         <if test="action != null">
            <if test="action == 'CREATE'">
               AND VERSION = 1
            </if>
            <if test="action == 'MODIFY'">
               AND VERSION > 1
            </if>
         </if>
         <if test="startDate != null and endDate != null">
            AND REG_DATE BETWEEN STR_TO_DATE(CONCAT(#{startDate},'000000'), '%Y%m%d%H%i%S') AND STR_TO_DATE(CONCAT(#{endDate},'235959'), '%Y%m%d%H%i%S')
         </if>
    </select>
    
    <select id="selectIsUseService" parameterType="skt.eiweb.model.model.Model" resultType="int">
       SELECT COUNT(*) FROM SERVICE WHERE MODEL_ID=#{modelId}
    </select>
</mapper>