<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="skt.eiweb.service.mapper.ServiceMapper">

    <select id="selectService" parameterType="skt.eiweb.service.model.ServiceDto" resultType="skt.eiweb.service.model.ServiceDto">
      SELECT * FROM ( 
        SELECT @RNUM := @RNUM + 1 AS NO, TAB.* FROM (
          SELECT DATE_FORMAT(CREATION_DATE,"%Y-%m-%d") CREATION_DATE, 
                 CREATION_DATE ORD, 
                 FN_GET_USER_NAME(SVC.USER_ID) USERNAME, 
                 SERVICE_ID, 
                 SERVICE_NAME, 
                 SVC.MODEL_ID,
                 MD.MODEL_NAME,
                 SVC.DAG_ID,
                 SVC.VERSION, 
                 RUN_CYCLE, 
                 SERVICE_GROUP_NAME,
                 SVC.SERVICE_DESC
		        FROM SERVICE SVC LEFT OUTER JOIN MODEL MD ON MD.MODEL_ID = SVC.MODEL_ID
		       WHERE 1=1
            <if test="serviceId != null">
              AND SERVICE_ID = #{serviceId}
            </if>
            <if test="modelId != null">
              AND SVC.MODEL_ID = #{modelId}
            </if>
            <if test="serviceGroupName != null">
              AND SVC.SERVICE_GROUP_NAME = #{serviceGroupName}
            </if>
            <if test="schKey != null and schKey != ''">
              AND (SERVICE_NAME LIKE CONCAT('%',#{schKey},'%' )
              OR DAG_ID LIKE CONCAT('%',#{schKey},'%' )
              OR SERVICE_ID LIKE CONCAT('%',#{schKey},'%' ))
            </if>
        ) TAB, (SELECT @RNUM :=0) B
        ORDER BY ORD DESC
		  ) OTAB
		  WHERE NO BETWEEN (((#{page}-1)*#{pageCount})+1) AND (#{page}*#{pageCount})
    </select>
    
    <select id="selectServiceTotalCount" parameterType="skt.eiweb.service.model.ServiceDto" resultType="int">
      SELECT COUNT(*) TOTAL_COUNT 
        FROM SERVICE SVC LEFT OUTER JOIN MODEL MD ON MD.MODEL_ID = SVC.MODEL_ID
       WHERE 1=1
        <if test="modelId != null">
          AND SVC.MODEL_ID = #{modelId}
        </if>
        <if test="serviceGroupName != null">
          AND SVC.SERVICE_GROUP_NAME = #{serviceGroupName}
        </if>
        <if test="schKey != null and schKey != ''">
          AND (SERVICE_NAME LIKE CONCAT('%',#{schKey},'%' )
            OR DAG_ID LIKE CONCAT('%',#{schKey},'%' )
            OR SERVICE_ID LIKE CONCAT('%',#{schKey},'%' ))
        </if>
    </select>
    
    <select id="selectServiceAll" parameterType="skt.eiweb.service.model.ServiceDto" resultType="skt.eiweb.service.model.ServiceDto">
      SELECT DATE_FORMAT(CREATION_DATE,"%Y-%m-%d") CREATION_DATE,
             CREATION_DATE ORD, 
             FN_GET_USER_NAME(SVC.USER_ID) USERNAME, 
             SERVICE_ID, 
             SERVICE_NAME, 
             SVC.MODEL_ID,
             MD.MODEL_NAME,
             SVC.DAG_ID,
             SVC.VERSION,
             RUN_CYCLE, 
             SERVICE_GROUP_NAME,
             SVC.SERVICE_DESC
		    FROM SERVICE SVC LEFT OUTER JOIN MODEL MD ON MD.MODEL_ID = SVC.MODEL_ID
		   WHERE 1=1
        <if test="serviceId != null">
          AND SERVICE_ID = #{serviceId}
        </if>

        <if test="modelId != null">
          AND SVC.MODEL_ID = #{modelId}
        </if>
        <if test="serviceGroupName != null">
          AND SVC.SERVICE_GROUP_NAME = #{serviceGroupName}
        </if>
        <if test="schKey != null and schKey != ''">
          AND (SERVICE_NAME LIKE CONCAT('%',#{schKey},'%' )
          OR DAG_ID LIKE CONCAT('%',#{schKey},'%' )
          OR SERVICE_ID LIKE CONCAT('%',#{schKey},'%' ))
        </if>
    </select>
    
    <select id="makeNextServiceId" resultType="string">
      SELECT FN_NEXT_SERVICE_ID()
    </select>
    
    <insert id="insertService" parameterType="skt.eiweb.service.model.ServiceDto">
      INSERT INTO SERVICE 
             (CREATION_DATE, USER_ID, SERVICE_ID, SERVICE_NAME, DAG_ID, MODEL_ID, VERSION, RUN_CYCLE, SERVICE_GROUP_NAME, SERVICE_DESC) 
      VALUES (CURRENT_TIMESTAMP, #{userId}, #{serviceId}, #{serviceName}, #{dagId}, #{modelId}, 1, #{runCycle}, #{serviceGroupName}, #{serviceDesc} )
    </insert>
    
    <update id="updateService" parameterType="skt.eiweb.service.model.ServiceDto">
      UPDATE SERVICE
         SET SERVICE_NAME= #{serviceName}, MODEL_ID= #{modelId}, VERSION=VERSION+1,SERVICE_GROUP_NAME=#{serviceGroupName},DAG_ID=#{dagId}
         <if test="runCycle != null">,RUN_CYCLE= #{runCycle}</if>
         <if test="serviceDesc != null">,SERVICE_DESC= #{serviceDesc}</if>
       WHERE SERVICE_ID = #{serviceId}
    </update>
    
    <select id="countServiceByServiceName" parameterType="skt.eiweb.service.model.ServiceDto" resultType="int">
      SELECT COUNT(*) FROM SERVICE WHERE SERVICE_NAME=#{serviceName}
      <if test="serviceId != null and serviceId != ''">
        AND SERVICE_ID != #{serviceId}
      </if>
    </select>
    
    <select id="countServiceByDagId" parameterType="skt.eiweb.service.model.ServiceDto" resultType="int">
      SELECT COUNT(*) FROM SERVICE WHERE DAG_ID=#{dagId}
      <if test="serviceId != null and serviceId != ''">
        AND SERVICE_ID != #{serviceId}
      </if>
    </select>
    
    <delete id="deleteService" parameterType="skt.eiweb.service.model.ServiceDto">
      DELETE FROM SERVICE WHERE SERVICE_ID=#{serviceId}
    </delete>

    <insert id="insertServiceCreHistory" parameterType="skt.eiweb.service.model.ServiceDto">
      INSERT INTO SERVICE_CRE_HISTORY 
             (CREATION_DATE, USER_ID, SERVICE_ID, SERVICE_NAME, DAG_ID, MODEL_ID, VERSION, RUN_CYCLE, SERVICE_GROUP_NAME, SERVICE_DESC)
		  SELECT CREATION_DATE, USER_ID, SERVICE_ID, SERVICE_NAME, DAG_ID, MODEL_ID, VERSION, RUN_CYCLE, SERVICE_GROUP_NAME, SERVICE_DESC
        FROM SERVICE 
       WHERE SERVICE_ID=#{serviceId}
    </insert>

    <select id="selectServiceExecHistoryStatus" parameterType="skt.eiweb.service.model.ServiceExecHistory" resultType="skt.eiweb.service.model.ServiceExecHistoryDto">
      SELECT IFNULL(SUM((CASE WHEN SVCH.SERVICE_STATUS = 'success' THEN 1 ELSE 0 END)),0) SUCCESS,
			       IFNULL(SUM((CASE WHEN SVCH.SERVICE_STATUS != 'success' THEN 1 ELSE 0 END)),0) WARNING
		    FROM SERVICE_EXEC_HISTORY SVCH, SERVICE SVC, MODEL MD
		   WHERE SVCH.SERVICE_ID = SVC.SERVICE_ID AND SVCH.VERSION = SVC.VERSION
         AND SVCH.MODEL_ID = MD.MODEL_ID 
         AND SVC.MODEL_ID = MD.MODEL_ID
        <if test="serviceId != null">
          AND SVCH.SERVICE_ID = #{serviceId}
        </if>
        <if test="serviceGroupName != null">
          AND SVCH.SERVICE_GROUP_NAME = #{serviceGroupName}
        </if>
        <if test="serviceStatus != null">
          <if test="serviceStatus == 'success'">
            AND SVCH.SERVICE_STATUS = 'success'
          </if>
          <if test="serviceStatus != 'success'">
            AND SVCH.SERVICE_STATUS != 'success'
          </if>
        </if>
        <if test="schKey != null">
          AND SVCH.SERVICE_NAME LIKE CONCAT('%',#{schKey},'%' )
            OR SVC.DAG_ID LIKE CONCAT('%',#{schKey},'%' )
        </if>
        <if test="startDate != null and endDate != null">
          AND SVCH.START_DATE BETWEEN STR_TO_DATE(CONCAT(#{startDate},'000000'), '%Y%m%d%H%i%S') AND STR_TO_DATE(CONCAT(#{endDate},'235959'), '%Y%m%d%H%i%S')
        </if>
    </select>

</mapper>