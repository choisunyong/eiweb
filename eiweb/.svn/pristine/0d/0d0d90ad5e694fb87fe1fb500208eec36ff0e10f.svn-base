<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="skt.eiweb.dashboard.mapper.DashboardMapper">

    <!-- 서비스 이력 _ begin -->
    <select id="selectDashboardServiceExecSummForGroup" resultType="skt.eiweb.dashboard.model.DashboardServiceDto">
      SELECT GRP.SERVICE_GROUP_NAME, 
             FORMAT((SELECT COUNT(*) FROM SERVICE S WHERE S.SERVICE_GROUP_NAME=GRP.SERVICE_GROUP_NAME),0) SERVICE_COUNT,
             FORMAT(IFNULL(COUNT(SVC.SERVICE_ID),0),0) EXEC_COUNT,
             FORMAT(SUM(CASE SEH.SERVICE_STATUS WHEN 'success' THEN 1 ELSE 0 END),0) SUCCESS,
             FORMAT(SUM(CASE SEH.SERVICE_STATUS WHEN 'success' THEN 0 ELSE 1 END),0) FAIL
        FROM SERVICE_EXEC_HISTORY SEH, SERVICE SVC, SERVICE_GROUP GRP
			 WHERE SVC.SERVICE_GROUP_NAME = GRP.SERVICE_GROUP_NAME
			   AND SEH.SERVICE_ID = SVC.SERVICE_ID
		   GROUP BY GRP.SERVICE_GROUP_NAME
    </select>
    
    <select id="selectDashboardServiceExecStatus" parameterType="skt.eiweb.dashboard.model.DashboardServiceDto" resultType="skt.eiweb.dashboard.model.DashboardServiceDto">
      SELECT FORMAT(COUNT(*),0) TOTAL,
             FORMAT(IFNULL(SUM(CASE WHEN SERVICE_STATUS = 'success' THEN 1 ELSE 0 END),0),0) SUCCESS,
             FORMAT(IFNULL(SUM(CASE WHEN SERVICE_STATUS = 'success' THEN 0 ELSE 1 END),0),0) FAIL
		    FROM SERVICE_EXEC_HISTORY
        <if test="isToday != null and isToday != ''">
          WHERE DATE_FORMAT(EXECUTE_DATE,'%Y%m%d') = DATE_FORMAT(NOW(),'%Y%m%d')
        </if>
    </select>
    
    <select id="selectDashboardServiceExecHistory" resultType="skt.eiweb.dashboard.model.DashboardServiceDto">
      SELECT SVC.SERVICE_NAME, GRP.SERVICE_GROUP_NAME, SEH.START_DATE, (SEH.END_DATE - SEH.START_DATE) ELASPED, SEH.SERVICE_STATUS
		    FROM SERVICE_EXEC_HISTORY SEH, SERVICE SVC, SERVICE_GROUP GRP
			 WHERE SVC.SERVICE_GROUP_NAME = GRP.SERVICE_GROUP_NAME
			   AND SEH.SERVICE_ID = SVC.SERVICE_ID
			   AND DATE_FORMAT(EXECUTE_DATE,'%Y%m%d') = DATE_FORMAT(NOW(),'%Y%m%d')
		   ORDER BY EXECUTE_DATE DESC
    </select>
    
    <select id="selectDashboardServiceExecStatusForToday" resultType="skt.eiweb.dashboard.model.DashboardServiceDto">
      SELECT HO.SERVICE_GROUP_NAME,HO.HOUR,DT.EXEC_COUNT,
             FORMAT(IFNULL(DT.SUCCESS,0),0) SUCCESS,
             FORMAT(IFNULL(DT.FAIL,0),0) FAIL
			  FROM (
          SELECT GRP.SERVICE_GROUP_NAME,
                 DATE_FORMAT(EXECUTE_DATE,"%H") HOUR,
                 IFNULL(COUNT(*),0) EXEC_COUNT,
                 IFNULL(SUM(CASE WHEN SEH.SERVICE_STATUS = 'success' THEN 1 ELSE 0 END),0) SUCCESS,
                 IFNULL(SUM(CASE WHEN SEH.SERVICE_STATUS != 'success' THEN 1 ELSE 0 END),0) FAIL
				    FROM SERVICE_EXEC_HISTORY SEH, SERVICE SVC, SERVICE_GROUP GRP
				   WHERE SVC.SERVICE_GROUP_NAME = GRP.SERVICE_GROUP_NAME
				     AND SEH.SERVICE_ID = SVC.SERVICE_ID
				     AND DATE_FORMAT(EXECUTE_DATE,'%Y%m%d') = DATE_FORMAT(NOW(),'%Y%m%d')
				   GROUP BY GRP.SERVICE_GROUP_NAME,DATE_FORMAT(EXECUTE_DATE,"%H")
			  ) DT
		    RIGHT OUTER JOIN 
		    (
          SELECT SERVICE_GROUP_NAME, HOUR 
            FROM SERVICE_GROUP G,(
              SELECT 24-0 HOUR 
              UNION SELECT 24-1 HOUR 
              UNION SELECT 24-2 HOUR 
              UNION SELECT 24-3 HOUR 
              UNION SELECT 24-4 HOUR 
              UNION SELECT 24-5 HOUR 
              UNION SELECT 24-6 HOUR
              UNION SELECT 24-7 HOUR 
              UNION SELECT 24-8 HOUR 
              UNION SELECT 24-9 HOUR 
              UNION SELECT 24-10 HOUR 
              UNION SELECT 24-11 HOUR 
              UNION SELECT 24-12 HOUR 
              UNION SELECT 24-13 HOUR
              UNION SELECT 24-14 HOUR 
              UNION SELECT 24-15 HOUR 
              UNION SELECT 24-16 HOUR 
              UNION SELECT 24-17 HOUR 
              UNION SELECT 24-18 HOUR 
              UNION SELECT 24-19 HOUR 
              UNION SELECT 24-20 HOUR
              UNION SELECT 24-21 HOUR 
              UNION SELECT 24-22 HOUR 
              UNION SELECT 24-23 HOUR
            ) 24H
            ORDER BY G.SERVICE_GROUP_NAME, 24H.HOUR
        ) HO
		    ON DT.SERVICE_GROUP_NAME = HO.SERVICE_GROUP_NAME AND DT.HOUR = HO.HOUR
		    ORDER BY HO.SERVICE_GROUP_NAME, HO.HOUR
    </select>
    <!-- 서비스 이력 _ end -->
    
    <!-- 리소스 이력 _ begin -->
    <select id="selectDashboardScaleInOutSummary" resultType="skt.eiweb.dashboard.model.DashboardScaleInOutDto">
      SELECT * FROM (
        SELECT  S.SERVER_ROLE,
                SUM(CASE WHEN DATE_FORMAT(RUN_DATE,"%Y-%m-%d") = DATE_FORMAT(DATE_SUB(CURRENT_TIMESTAMP,INTERVAL 0 DAY),"%Y-%m-%d") THEN (CASE WHEN ACTION like 'start' THEN 1 ELSE (CASE WHEN ACTION like 'stop' THEN -1 ELSE 0 END) END) END) V1,
			          SUM(CASE WHEN DATE_FORMAT(RUN_DATE,"%Y-%m-%d") = DATE_FORMAT(DATE_SUB(CURRENT_TIMESTAMP,INTERVAL 1 DAY),"%Y-%m-%d") THEN (CASE WHEN ACTION like 'start' THEN 1 ELSE (CASE WHEN ACTION like 'stop' THEN -1 ELSE 0 END) END) END) V2,
			          SUM(CASE WHEN DATE_FORMAT(RUN_DATE,"%Y-%m-%d") = DATE_FORMAT(DATE_SUB(CURRENT_TIMESTAMP,INTERVAL 2 DAY),"%Y-%m-%d") THEN (CASE WHEN ACTION like 'start' THEN 1 ELSE (CASE WHEN ACTION like 'stop' THEN -1 ELSE 0 END) END) END) V3,
			          SUM(CASE WHEN DATE_FORMAT(RUN_DATE,"%Y-%m-%d") = DATE_FORMAT(DATE_SUB(CURRENT_TIMESTAMP,INTERVAL 3 DAY),"%Y-%m-%d") THEN (CASE WHEN ACTION like 'start' THEN 1 ELSE (CASE WHEN ACTION like 'stop' THEN -1 ELSE 0 END) END) END) V4,
			          SUM(CASE WHEN DATE_FORMAT(RUN_DATE,"%Y-%m-%d") = DATE_FORMAT(DATE_SUB(CURRENT_TIMESTAMP,INTERVAL 4 DAY),"%Y-%m-%d") THEN (CASE WHEN ACTION like 'start' THEN 1 ELSE (CASE WHEN ACTION like 'stop' THEN -1 ELSE 0 END) END) END) V5,
			          SUM(CASE WHEN DATE_FORMAT(RUN_DATE,"%Y-%m-%d") = DATE_FORMAT(DATE_SUB(CURRENT_TIMESTAMP,INTERVAL 5 DAY),"%Y-%m-%d") THEN (CASE WHEN ACTION like 'start' THEN 1 ELSE (CASE WHEN ACTION like 'stop' THEN -1 ELSE 0 END) END) END) V6,
			          SUM(CASE WHEN DATE_FORMAT(RUN_DATE,"%Y-%m-%d") = DATE_FORMAT(DATE_SUB(CURRENT_TIMESTAMP,INTERVAL 6 DAY),"%Y-%m-%d") THEN (CASE WHEN ACTION like 'start' THEN 1 ELSE (CASE WHEN ACTION like 'stop' THEN -1 ELSE 0 END) END) END) V7,
			          ((REPLACE(S.SERVER_ROLE,'worker','')+10)-3) SORT
		      FROM (
            SELECT EXECUTE_DATE RUN_DATE,USER_ID,SERVER_NAME,ACTION
              FROM REST_EXEC_HISTORY
             WHERE SUCCESS = 1
			         AND EXECUTE_DATE BETWEEN DATE_SUB(CURRENT_TIMESTAMP,INTERVAL 6 DAY) AND CURRENT_TIMESTAMP
		      ) h, (
            SELECT CODE_NAME SERVER_NAME, CODE INSTANCE , VALUE SERVER_ROLE
              FROM COMMON_CODE 
             WHERE GROUP_CODE='SCALE_IN_OUT_LIST' AND USE_YN='Y' AND (VALUE = 'manager' OR VALUE LIKE CONCAT('%','worker','%'))
          ) s
          WHERE H.SERVER_NAME = S.SERVER_NAME
		      GROUP BY S.SERVER_ROLE
		  ) A
		  UNION ALL
		  SELECT * FROM (
        SELECT VALUE, 0 V1, 0 V2, 0 V3, 0 V4, 0 V5, 0 V6, 0 V7, SORT
          FROM COMMON_CODE 
         WHERE GROUP_CODE='SCALE_IN_OUT_LIST' AND USE_YN='Y'
			     AND (VALUE IN ('worker1','worker2') OR VALUE = 'manager') 
			) B
		  ORDER BY SORT DESC
    </select>
    
    <select id="selectTodayCpuHour" resultType="skt.eiweb.dashboard.model.CpuHistoryDto">
      SELECT DATE_FORMAT(RECEIVE_DATE,'%H') HOUR,
             INSTANCE,SERVER_NAME, 
             ROUND(AVG(CPU_AVERAGE),2) CPU_AVERAGE
		    FROM CPU_HISTORY
		   WHERE DATE_FORMAT(RECEIVE_DATE,'%Y%m%d') = DATE_FORMAT(NOW(),'%Y%m%d')
		   GROUP BY DATE_FORMAT(RECEIVE_DATE,'%H'),INSTANCE,SERVER_NAME
    </select>
    
    <select id="selectTodayCpuAvg" resultType="skt.eiweb.dashboard.model.CpuHistoryDto">
      SELECT ROUND(AVG(CPU_AVERAGE),1) CPU_AVERAGE 
        FROM CPU_HISTORY
		   WHERE DATE_FORMAT(RECEIVE_DATE,'%Y%m%d') = DATE_FORMAT(NOW(),'%Y%m%d')
    </select>
    
    <select id="selectCpuSummListForHour" resultType="skt.eiweb.dashboard.model.CpuHistoryDto">
      SELECT DATE_FORMAT(RECEIVE_DATE,'%H') RECEIVE_DATE,
             INSTANCE,
             SERVER_NAME,
             ROUND(AVG(CPU_AVERAGE),2) CPU_AVERAGE
		    FROM CPU_HISTORY
		   WHERE DATE_FORMAT(RECEIVE_DATE,'%Y%m%d') = DATE_FORMAT(NOW(),'%Y%m%d')
		   GROUP BY DATE_FORMAT(RECEIVE_DATE,'%H'),INSTANCE,SERVER_NAME
		   UNION ALL
      SELECT RECEIVE_DATE,
             'total' INSTANCE,
             'Total' SERVER_NAME,
             SUM(CPU_AVERAGE) CPU_AVERAGE 
        FROM (
          SELECT DATE_FORMAT(RECEIVE_DATE,'%H') RECEIVE_DATE,
                 INSTANCE,
                 SERVER_NAME,
                 ROUND(AVG(CPU_AVERAGE),2) CPU_AVERAGE
			      FROM CPU_HISTORY
			     WHERE DATE_FORMAT(RECEIVE_DATE,'%Y%m%d') = DATE_FORMAT(NOW(),'%Y%m%d')
			     GROUP BY DATE_FORMAT(RECEIVE_DATE,'%H'),INSTANCE,SERVER_NAME
		    ) A
		   GROUP BY RECEIVE_DATE
    </select>
    
    <select id="selectCpuSummListForDay" resultType="skt.eiweb.dashboard.model.CpuHistoryDto">
      SELECT DATE_FORMAT(RECEIVE_DATE,'%m/%d') RECEIVE_DATE, INSTANCE, SERVER_NAME, ROUND(CPU_AVERAGE,2) CPU_AVERAGE
		    FROM CPU_HIST_SUMMARY
		   WHERE DATE_FORMAT(RECEIVE_DATE,'%Y%m') = DATE_FORMAT(NOW(),'%Y%m')
		   UNION ALL
      SELECT RECEIVE_DATE, 'total' INSTANCE, 'Total' SERVER_NAME, SUM(CPU_AVERAGE) CPU_AVERAGE 
        FROM (
          SELECT DATE_FORMAT(RECEIVE_DATE,'%m/%d') RECEIVE_DATE, 
                 INSTANCE, 
                 SERVER_NAME, 
                 ROUND(CPU_AVERAGE,2) CPU_AVERAGE, 
                 CPU_UNIT 
			      FROM CPU_HIST_SUMMARY
			     WHERE DATE_FORMAT(RECEIVE_DATE,'%Y%m') = DATE_FORMAT(NOW(),'%Y%m')
		    ) A GROUP BY RECEIVE_DATE
    </select>
    
    <select id="selectCpuSummListForMonth" resultType="skt.eiweb.dashboard.model.CpuHistoryDto">
      SELECT DATE_FORMAT(RECEIVE_DATE,'%Y/%m') RECEIVE_DATE,
             INSTANCE,SERVER_NAME,
             ROUND(AVG(CPU_AVERAGE),2) CPU_AVERAGE
		    FROM CPU_HIST_SUMMARY
		   WHERE DATE_FORMAT(RECEIVE_DATE,'%Y') = DATE_FORMAT(NOW(),'%Y')
		   GROUP BY DATE_FORMAT(RECEIVE_DATE,'%Y/%m'),INSTANCE,SERVER_NAME
		   UNION ALL
		  SELECT RECEIVE_DATE,'total' INSTANCE,'Total' SERVER_NAME,SUM(CPU_AVERAGE) CPU_AVERAGE
		    FROM (
          SELECT DATE_FORMAT(RECEIVE_DATE,'%Y/%m') RECEIVE_DATE,
                 INSTANCE,SERVER_NAME,
                 ROUND(AVG(CPU_AVERAGE),2) CPU_AVERAGE
			      FROM CPU_HIST_SUMMARY
			     WHERE DATE_FORMAT(RECEIVE_DATE,'%Y') = DATE_FORMAT(NOW(),'%Y')
			     GROUP BY DATE_FORMAT(RECEIVE_DATE,'%Y/%m'),INSTANCE,SERVER_NAME
		    ) A GROUP BY RECEIVE_DATE
    </select>
    
    <select id="selectCpuAvgList" resultType="skt.eiweb.dashboard.model.CpuHistoryDto">
      SELECT * FROM (
        SELECT DATE_FORMAT(RECEIVE_DATE,'%H:%i:%s') RECEIVE_DATE,
               ROUND(AVG(CPU_AVERAGE),2) CPU_AVERAGE
      		FROM CPU_HISTORY
		     WHERE DATE_FORMAT(RECEIVE_DATE,'%Y%m%d') = DATE_FORMAT(NOW(),'%Y%m%d')
		     GROUP BY DATE_FORMAT(receive_date,'%H:%i:%s')
		     ORDER BY RECEIVE_DATE DESC
		     LIMIT 100
		  ) A ORDER BY RECEIVE_DATE
    </select>
    <!-- 리소스 이력 _ end -->
     
    <insert id="insertCpuHistory" parameterType="skt.eiweb.dashboard.model.CpuHistory">
      INSERT INTO CPU_HISTORY 
             (SERVER_NAME,CPU_AVERAGE,INSTANCE<if test="cpuUnit != null and cpuUnit != ''">,CPU_UNIT</if>) 
      VALUES (#{serverName},#{cpuAverage},#{instance}<if test="cpuUnit != null and cpuUnit != ''">,#{cpuUnit}</if>)
    </insert>
    
    <insert id="insertCpuHistSummary">
      INSERT INTO CPU_HIST_SUMMARY
      SELECT DATE_FORMAT(RECEIVE_DATE,'%Y%m%d') RECEIVE_DATE,
             INSTANCE,
             SERVER_NAME,
             ROUND(AVG(CPU_AVERAGE),2) CPU_AVERAGE,
             MAX(CPU_UNIT) CPU_UNIT
		    FROM CPU_HISTORY
		   GROUP BY DATE_FORMAT(RECEIVE_DATE,'%Y%m%d'), INSTANCE, SERVER_NAME
		         ON DUPLICATE KEY UPDATE CPU_AVERAGE=CPU_AVERAGE
    </insert>
</mapper>