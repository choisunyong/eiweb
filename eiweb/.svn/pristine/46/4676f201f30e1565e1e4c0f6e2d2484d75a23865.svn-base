<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="skt.eiweb.authority.mapper.UserMapper">

    <insert id="insertUser" parameterType="skt.eiweb.authority.model.User">
      <![CDATA[
        INSERT INTO USER 
               (SIGNUP_DATE, USER_ID, PASSWORD, USER_NAME, USER_EMAIL, USER_PERMISSION, ACTIVATE) 
        VALUES (CURRENT_TIMESTAMP, #{userId}, #{password}, #{userName}, #{userEmail}, #{userPermission}, 1 )
      ]]>
    </insert>

    <select id="selectUser" parameterType="skt.eiweb.authority.model.User" resultType="skt.eiweb.authority.model.User">
      SELECT * FROM USER
       WHERE 1=1
   			<if test="userId != null">AND USER_ID = #{userId}</if>
   			<if test="userName != null">AND USER_NAME = #{userName}</if>
    		<if test="userEmail != null">AND USER_EMAIL = #{userEmail}</if>
        <if test="activate != null">AND ACTIVATE = #{activate}</if>
    </select>

    <insert id="insertLoginHist" parameterType="skt.eiweb.authority.model.LoginHist">
      INSERT INTO LOGIN_HISTORY 
             (USER_ID, SESSION, LOGIN_DATE)
      VALUES (#{userId}, #{session}, CURRENT_TIMESTAMP) 
    </insert>

    <select id="selectUserBySessionId" parameterType="skt.eiweb.authority.model.LoginHist" resultType="skt.eiweb.authority.model.User">
      SELECT USR.USER_ID,
             USR.USER_NAME,
             USR.USER_PERMISSION 
        FROM USER USR, LOGIN_HISTORY HIS
       WHERE USR.USER_ID = HIS.USER_ID 
         AND SESSION = #{session}
       GROUP BY USR.USER_ID,
                USR.USER_NAME,
                USR.USER_PERMISSION,
                USR.ACTIVATE
    </select>

    <select id="selectUserByPw" parameterType="skt.eiweb.authority.model.User" resultType="skt.eiweb.authority.model.User">
      SELECT * FROM USER 
       WHERE 1=1
        <if test="userId != null">AND USER_ID = #{userId}</if>
        <if test="userName != null">AND USER_NAME = #{userName}</if>
        <if test="userEmail != null">AND USER_EMAIL = #{userEmail}</if>
        <if test="activate != null">AND ACTIVATE = #{activate}</if>
        <if test="password != null">AND PASSWORD = #{password}</if>
        <if test="schKey != null">AND USER_ID LIKE CONCAT('%',#{schKey},'%')</if>
    </select>

    <update id="updatePassword" parameterType="skt.eiweb.authority.model.User">
      UPDATE USER 
         SET PASSWORD=#{password} 
       WHERE USER_ID=#{userId}
    </update>

    <select id="selectUserPage" parameterType="skt.eiweb.authority.model.User" resultType="skt.eiweb.authority.model.User">
      SELECT * FROM ( 
        SELECT @RNUM := @RNUM + 1 AS NO, TAB.* FROM (
          SELECT USER_ID,
                 DATE_FORMAT(SIGNUP_DATE,'%Y-%m-%d') SIGNUP_DATE, 
                 SIGNUP_DATE ORD,
                 USER_NAME,
                 USER_EMAIL,
                 USER_PERMISSION,
                 FN_GET_CODE_NAME('PERMISSION',USER_PERMISSION) USER_GROUP,
			           (SELECT MAX(LOGIN_DATE) FROM LOGIN_HISTORY WHERE USER_ID=USR.USER_ID) LOGIN_DATE,
			           (CASE ACTIVATE WHEN 1 THEN 'Y' ELSE 'N' END) ACTIVATE
		        FROM USER USR
    		   WHERE 1=1
            <if test="userId != null">AND USER_ID = #{userId}</if>
            <if test="userName != null">AND USER_NAME = #{userName}</if>
            <if test="userEmail != null">AND USER_EMAIL = #{userEmail}</if>
            <if test="activate != null">AND ACTIVATE = #{activate}</if>
			      <if test="schKey != null">
              AND (USER_ID LIKE CONCAT('%',#{schKey},'%')
              OR USER_NAME LIKE CONCAT('%',#{schKey},'%'))
            </if>
            <if test="userPermission != null">
              AND (FN_GET_CODE_NAME('PERMISSION',user_permission) LIKE CONCAT('%',#{userPermission},'%')
              OR USER_PERMISSION LIKE CONCAT('%',#{userPermission},'%'))
            </if>
			
		    ) TAB, (SELECT @RNUM :=0) B
		    ORDER BY ORD DESC
		  ) OTAB
		  WHERE NO BETWEEN (((#{page}-1)*#{pageCount})+1) AND (#{page}*#{pageCount})
    </select>

    <select id="selectUserPageTotalCount" parameterType="skt.eiweb.authority.model.User" resultType="int">
      SELECT COUNT(*) FROM USER
			 WHERE 1=1
   			<if test="userId != null">AND USER_ID = #{userId}</if>
   			<if test="userName != null">AND USER_NAME = #{userName}</if>
    		<if test="userEmail != null">AND USER_EMAIL = #{userEmail}</if>
   			<if test="activate != null">AND ACTIVATE = #{activate}</if>
        <if test="schKey != null">
          AND (USER_ID LIKE CONCAT('%',#{schKey},'%')
          OR USER_NAME LIKE CONCAT('%',#{schKey},'%'))
        </if>
        <if test="userPermission != null">
          AND (FN_GET_CODE_NAME('PERMISSION',USER_PERMISSION) LIKE CONCAT('%',#{userPermission},'%')
          OR USER_PERMISSION LIKE CONCAT('%',#{userPermission},'%'))
        </if>
    </select>

    <update id="updateUser" parameterType="skt.eiweb.authority.model.User">
      UPDATE USER 
         SET ACTIVATE = <if test="activate != null">#{activate}</if><if test="activate == null">1</if>
            <if test="userName != null">,USER_NAME = #{userName}</if>
            <if test="userPermission != null">,USER_PERMISSION = #{userPermission}</if>
			 WHERE USER_ID = #{userId}
    </update>
</mapper>
